<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>CONNMARK target</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="Iptables Tutorial 1.2.2"
HREF="book1.htm"><LINK
REL="UP"
TITLE="Iptables targets and jumps"
HREF="c8815.htm"><LINK
REL="PREVIOUS"
TITLE="CLUSTERIP target"
HREF="x8906.htm"><LINK
REL="NEXT"
TITLE="CONNSECMARK target"
HREF="x9235.htm"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="table.css"></HEAD
><BODY
CLASS="SECTION"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>Iptables Tutorial 1.2.2</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="x8906.htm"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
>Chapter 11. Iptables targets and jumps</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="x9235.htm"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECTION"
><H1
CLASS="SECTION"
><A
NAME="CONNMARKTARGET"
>CONNMARK target</A
></H1
><P
>The CONNMARK target is used to set a mark on a whole
connection, much the same way as the MARK target does. It
can then be used together with the connmark match to match
the connection in the future. For example, say we see a specific pattern in a
header, and we don't want to mark just that packet, but the whole connection.
The CONNMARK target is a perfect solution in that case. 
    </P
><P
>The CONNMARK target is available in all chains and all
tables, but remember that the nat table is only traversed by the first packet
in a connection, so the CONNMARK target will have no effect
if you try to use it for subsequent packets after the first one in here. It can
take one of four different options as seen below. 
    </P
><DIV
CLASS="TABLE"
><A
NAME="TABLE.CONNMARKTARGET"
></A
><P
><B
>Table 11-3. CONNMARK target options</B
></P
><TABLE
BORDER="1"
FRAME="border"
RULES="all"
CLASS="CALSTABLE"
><COL
WIDTH="77"><COL
WIDTH="1*"><TBODY
><TR
><TD
>Option</TD
><TD
>--set-mark</TD
></TR
><TR
><TD
>Example</TD
><TD
>iptables -t nat -A PREROUTING -p tcp --dport 80 -j
	    CONNMARK --set-mark 4</TD
></TR
><TR
><TD
>Explanation</TD
><TD
>This option sets a mark on the connection. The mark can be an
unsigned long int, which means values between
0 and 4294967295l is valid.
Each bit can also be masked by doing --set-mark 12/8. This
will only allow the bits in the mask to be set out of all the bits in the mark.
In this example, only the 4th bit will be set, not the 3rd. 12 translates to
1100 in binary, and 8 to 1000, and only the bits set in the mask are allowed to
be set. Hence, only the 4th bit, or 8, is set in the actual mark. 
            </TD
></TR
><TR
><TD
>Option</TD
><TD
>--save-mark</TD
></TR
><TR
><TD
>Example</TD
><TD
>iptables -t mangle -A PREROUTING --dport 80 -j
	    CONNMARK --save-mark</TD
></TR
><TR
><TD
>Explanation</TD
><TD
>The --save-mark target option is used to save the packet
mark into the connection mark. For example, if you have set a packet mark with
the MARK target, you can then move this mark to mark the
whole connection with the --save-mark match. The mark can
also be masked by using the --mask option described further
down. 
            </TD
></TR
><TR
><TD
>Option</TD
><TD
>--restore-mark</TD
></TR
><TR
><TD
>Example</TD
><TD
>iptables -t mangle -A PREROUTING --dport 80 -j
	    CONNMARK --restore-mark</TD
></TR
><TR
><TD
>Explanation</TD
><TD
>This target option restores the packet mark from the connection mark as defined
by the CONNMARK. A mask can also be defined using the
--mask option as seen below. If a mask is set, only the
masked options will be set. Note that this target option is only valid for use
in the mangle table. 
            </TD
></TR
><TR
><TD
>Option</TD
><TD
>--mask</TD
></TR
><TR
><TD
>Example</TD
><TD
>iptables -t mangle -A PREROUTING --dport 80 -j
	    CONNMARK --restore-mark --mask 12</TD
></TR
><TR
><TD
>Explanation</TD
><TD
>The --mask option must be used in unison with the
--save-mark and --restore-mark options.
The --mask option specifies an and-mask that should be
applied to the mark values that the other two options will give. For example,
if the restored mark from the above example would be 15, it would mean that the
mark was 1111 in binary, while the mask is 1100. 1111 and 1100 equals 1100. 
            </TD
></TR
></TBODY
></TABLE
></DIV
><DIV
CLASS="NOTE"
><P
></P
><TABLE
CLASS="NOTE"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="images/note.gif"
HSPACE="5"
ALT="Note"></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>Works under Linux kernel 2.6.
      </P
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="x8906.htm"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="book1.htm"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="x9235.htm"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>CLUSTERIP target</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="c8815.htm"
ACCESSKEY="U"
>Up</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>CONNSECMARK target</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>